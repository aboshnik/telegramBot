
## Функции

- **Регистрация сотрудников** через пошаговый ввод данных (ФИО, телефон, должность, отдел)
- **Проверка данных** по базе данных `LexemaCard` (таблица `Лексема_Кадры_ЛичнаяКарточка`)
- **Автоматическая генерация инвайт-ссылок** в новостной канал с TTL
- **Управление черным списком** - автоматическое разбанивание работающих сотрудников
- **Проверка уволенных** - автоматическая блокировка уволенных сотрудников
- **Отдельная meta-БД** для каналов отделов, списка админов и логов
- **Логирование действий** админов в meta-БД и в выбранный чат
- **Ночная проверка** статусов сотрудников (0:00-5:00 МСК)

## Установка на сервере завода

### 1. Подготовка базы данных в SSMS

См. раздел **"Настройка на заводе (SQL Server)"** ниже для настройки таблицы и полей.

### 2. Настройка подключения к БД

1) Скопировать `env.example` в `.env` и заполнить:
```env
BOT_TOKEN=ваш_токен_бота
CHANNEL_ID=@fallback_channel   # запасной канал, если нет привязки отдела
NEWS_CHANNEL_ID=@news_channel  # новостной канал (можно настроить командой)
DB_URL="Driver={ODBC Driver 17 for SQL Server};Server=имя_сервера;Database=имя_БД;Uid=пользователь;Pwd=пароль;TrustServerCertificate=yes;"
META_DB_URL="file:./prisma/meta.db"
LINK_TTL_HOURS=24
OWNER_ID=ваш_telegram_id
ADMIN_LOG_CHAT_ID=...         # можно настроить командой
NODE_ENV=production
```

**Важно для DB_URL:**
- `Server` - имя или IP адрес SQL Server (например: `192.168.1.100` или `SQLSERVER\INSTANCE`)
- `Database` - название базы данных
- `Uid` - имя пользователя SQL Server
- `Pwd` - пароль пользователя
- `TrustServerCertificate=yes` - может потребоваться для самоподписанных сертификатов

**Пример строки подключения:**
```
DB_URL="Driver={ODBC Driver 17 for SQL Server};Server=192.168.1.100;Database=Кадры;Uid=telegram_bot_user;Pwd=SecurePassword123;TrustServerCertificate=yes;"
```

2) Установить зависимости:
```bash
npm install
```

3) Сгенерировать Prisma клиенты:
```bash
npm run prisma:generate
npm run prisma:generate:meta
```

4) Инициализировать meta-БД:
```bash
npm run prisma:push:meta
```

## Запуск

### Локально:
```bash
npm start
```

### На сервере завода (Windows Server / Linux):

#### Для Windows Server:

1) Установи Node.js (версия 20+):
   - Скачайте с https://nodejs.org/
   - Или через Chocolatey: `choco install nodejs`

2) Установи ODBC Driver 17 for SQL Server:
   - Скачайте с https://learn.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server
   - Установите драйвер на сервере

3) Установи зависимости:
```bash
npm install
```

4) Сгенерируй Prisma клиенты:
```bash
npm run prisma:generate
npm run prisma:generate:meta
```

5) Инициализируй meta-БД:
```bash
npm run prisma:push:meta
```

6) Запусти бота:
```bash
npm start
```

#### Для Linux (Ubuntu/Debian):

1) Установи Node.js (версия 20+):
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

2) Установи ODBC Driver для SQL Server:
```bash
# Добавить репозиторий Microsoft
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list

# Установить драйвер
sudo apt-get update
sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17
```

3) Установи зависимости:
```bash
npm install
```

4) Сгенерируй Prisma клиенты:
```bash
npm run prisma:generate
npm run prisma:generate:meta
```

5) Инициализируй meta-БД:
```bash
npm run prisma:push:meta
```

6) Запусти бота:
```bash
npm start
```

## Деплой на сервер

### Процесс деплоя:

1. **Подготовка кода (локально):**
   - Разработайте и протестируйте бота локально
   - Убедитесь, что все работает
   - Закоммитьте изменения в Git (если используете)

2. **Перенос на сервер:**
   - Скопируйте все файлы проекта на сервер (через FTP, SCP, Git clone и т.д.)
   - Или загрузите архив и распакуйте на сервере

3. **Настройка на сервере:**
   - Установите Node.js (если еще не установлен)
   - Установите зависимости: `npm install`
   - Настройте `.env` файл с правильными данными
   - Сгенерируйте Prisma клиенты: `npm run prisma:generate` и `npm run prisma:generate:meta`
   - Инициализируйте meta-БД: `npm run prisma:push:meta`

4. **Запуск через PM2 (на сервере):**
   - Установите PM2: `npm install -g pm2`
   - Запустите бота: `pm2 start src/index.js --name telegram-bot`
   - Сохраните: `pm2 save`
   - Настройте автозапуск: `pm2 startup`



### Для работы 24/7 используй PM2:

**PM2** - это процесс-менеджер для Node.js приложений, который позволяет:
- Запускать бота в фоновом режиме
- Автоматически перезапускать при сбоях
- Управлять логами
- Автоматически запускать при перезагрузке сервера

**Установка и запуск:**
```bash
# Установить PM2 глобально
npm install -g pm2

# Запустить бота через PM2
pm2 start src/index.js --name telegram-bot

# Сохранить список процессов
pm2 save

# Настроить автозапуск при перезагрузке сервера
pm2 startup
# Выполните команду, которую выведет PM2 (обычно что-то вроде: sudo env PATH=... pm2 startup systemd -u user --hp /home/user)
```

**Полезные команды PM2:**
```bash
pm2 list              # Список запущенных процессов
pm2 logs telegram-bot # Просмотр логов бота
pm2 restart telegram-bot  # Перезапустить бота
pm2 stop telegram-bot     # Остановить бота
pm2 delete telegram-bot   # Удалить из PM2
pm2 monit             # Мониторинг процессов в реальном времени
```

**Альтернатива (без PM2):**
Если не хотите использовать PM2, можно запустить бота через `nohup` или как системный сервис (systemd на Linux).

## Команды

### Для всех пользователей:
- `/start` - Начать регистрацию
- `/reset` - Сбросить состояние регистрации
- `/help` - Показать справку по командам

### Команды администратора:
- `/test_data` - Проверить данные сотрудника
- `/user_status <id|@username>` - Статус пользователя в канале отдела
- `/check_hist [id|@username]` - История действий (последние 10 записей)
- `/news <текст>` - Отправить новость в новостной канал
- `/remove_user <id|@username> <причина>` - Забанить пользователя в канале отдела
- `/bind_department <Отдел>` - Привязать канал к отделу (выполнить в канале)

### Команды владельца:
- `/add_admin <id|@username>` - Добавить администратора
- `/unadd_admin <id|@username>` - Удалить администратора
- `/list_employees` - Список всех сотрудников
- `/set_admin_log_chat` - Установить чат для логов админов (выполнить в чате)
- `/set_news_channel` - Установить новостной канал (выполнить в канале)
- `/check_fired` - Проверить уволенных сотрудников
- `/test_unban` - Тест разбана работающих сотрудников (в removed users)
- `/unbind_all` - Отвязать все каналы от отделов
- `/bind_department <Отдел>` - Привязать/изменить канал к отделу (выполнить в канале)

## Структура проекта

- `src/bot.js` - Основной файл с командами и логикой бота
- `src/index.js` - Точка входа, запуск бота и фоновые задачи
- `src/config.js` - Конфигурация из переменных окружения
- `src/db.js` - Подключение к основной БД (LexemaCard)
- `src/dbMeta.js` - Подключение к meta-БД
- `src/services/employeeService.js` - Сервис для работы с сотрудниками
- `src/services/inviteService.js` - Сервис для работы с инвайт-ссылками
- `prisma/schema.prisma` - Схема основной БД (LexemaCard)
- `prisma/meta.prisma` - Схема meta-БД (каналы отделов, админы, логи)

## Настройка на заводе (SQL Server)

### Требования к таблице в SSMS

Бот работает с таблицей `Лексема_Кадры_ЛичнаяКарточка` (или `Lexema_Kadry_LichnayaKartochka`) в SQL Server.

#### Обязательные поля для работы бота:

1. **VCode** (Int, Primary Key) - Код сотрудника
2. **Фамилия** (nvarchar) - Фамилия сотрудника
3. **Имя** (nvarchar) - Имя сотрудника
4. **Отчество** (nvarchar) - Отчество сотрудника
5. **Подразделение** (Int) - ID подразделения/отдела
6. **Должность** (Int) - ID должности
7. **Сотовый** (nvarchar) - Номер телефона
8. **ДатаУвольнения** (datetime, nullable) - Дата увольнения (NULL = работает)

#### Поля для интеграции с Telegram (добавить если отсутствуют):

9. **ТелеграмID** (bigint, nullable) - Telegram ID пользователя
   - Тип данных: `bigint`
   - Разрешить NULL: Да
   - Пример значения: `123456789`

10. **ТелеграмЮзернейм** (nvarchar, nullable) - Telegram username (без @)
    - Тип данных: `nvarchar(255)`
    - Разрешить NULL: Да
    - Пример значения: `username`

11. **ЧерныйСписок** (bit, nullable) - Флаг черного списка
    - Тип данных: `bit`
    - Разрешить NULL: Да
    - Значения: `0` = не в черном списке, `1` = в черном списке
    - По умолчанию: `0`



- **ТелеграмID** - заполняется автоматически при регистрации сотрудника через бота
- **ТелеграмЮзернейм** - заполняется автоматически при регистрации (если у пользователя есть username)
- **ЧерныйСписок** - управляется автоматически:
  - `0` или `NULL` = сотрудник не в черном списке
  - `1` = сотрудник в черном списке (заблокирован)
  - Автоматически устанавливается в `1` при увольнении (если заполнена ДатаУвольнения)
  - Автоматически сбрасывается в `0` если сотрудник работает (ДатаУвольнения = NULL)

### Важно:

- Поле **ДатаУвольнения** должно быть `NULL` для работающих сотрудников
- Если **ДатаУвольнения** заполнена - сотрудник считается уволенным и будет заблокирован
- Если **ЧерныйСписок** = `1`, но **ДатаУвольнения** = `NULL` - сотрудник будет автоматически разбанен

## База данных

### Основная БД (SQL Server)
- Таблица `Лексема_Кадры_ЛичнаяКарточка` (или `Lexema_Kadry_LichnayaKartochka`)
- Содержит данные сотрудников: ФИО, должность, отдел, телефон, Telegram ID, дата увольнения, черный список

### Meta-БД (SQLite)
- `DepartmentChannel` - привязка каналов к отделам
- `Admin` - список администраторов
- `AdminLog` - журнал действий админов
- `AdminSettings` - настройки (лог-чат, новостной канал)
- `InviteLink` - персональные инвайт-ссылки
- `AuditLog` - аудит-лог действий пользователей
- `EmployeeRef` - справочник сотрудников (legacy)
- `User` - зарегистрированные пользователи

## Особенности

### Автоматическое управление черным списком
- Если сотрудник в черном списке, но не уволен (`terminationDate = NULL`) - автоматически разбанивается
- Если сотрудник уволен (`terminationDate != NULL`) - автоматически блокируется

### Ночная проверка (0:00-5:00 МСК)
- Автоматическая проверка статусов сотрудников
- Разбанивание работающих сотрудников
- Блокировка уволенных сотрудников

### Инвайт-ссылки
- Персональные ссылки с TTL (время жизни)
- Одноразовые ссылки (member_limit: 1)
- Автоматическая очистка просроченных ссылок

