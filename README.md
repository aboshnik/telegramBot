# Telegram bot (telegraf + Prisma + SQLite)

## Что делает
- Пошагово собирает ФИО, должность, отдел.
- Проверяет сотрудника в таблице `employees_ref`.
- При успехе создаёт или возвращает персональную инвайт-ссылку в канал/группу отдела с TTL (использует маппинг `department_channel`).
- Логирует события в `audit_logs`.

## Настройка окружения
1) Скопируй `env.example` в `.env` и заполни:
```
BOT_TOKEN=xxx
CHANNEL_ID=@fallback_channel_or_chat_id   # используется как запасной, если нет маппинга отдела
DB_URL="file:./dev.db"
META_DB_URL="file:./meta.db"              # отдельная БД для каналов/админов
LINK_TTL_HOURS=24
OWNER_ID=123456789
NODE_ENV=development
```
2) Установи зависимости: `npm install`
3) Сгенерируй клиента Prisma: `npx prisma generate`
4) Применить схему к SQLite: `npx prisma db push`
5) (Опционально) Засейдить тестовых сотрудников: `npm run seed`

## Запуск
- Локально: `npm run start`

## Основные файлы
- `src/index.js` — запуск бота.
- `src/bot.js` — сценарий шагов и выдача ссылок.
- `src/services/*` — работа с сотрудниками и ссылками.
- `prisma/schema.prisma` — схема SQLite (готова для последующей замены на Postgres).
- `prisma/meta.prisma` — отдельная схема для БД с каналами и администраторами.

## TTL ссылок
- Конфиг `LINK_TTL_HOURS` (по умолчанию 24).
- В таблице хранится `expires_at` (UTC) и `ttlSeconds` для удобства логики.

## Маппинг отдел → канал
- Таблица `department_channel(department, channelId)`.
- При выдаче ссылки бот ищет `channelId` по отделу сотрудника; если нет — использует `CHANNEL_ID` как запасной, иначе ошибка.
- `channelId` должен быть реальным chat_id (`-100...`) или @username чата/канала, где бот — админ. В примере сидов проставлены названия отделов как заглушки — замени на реальные идентификаторы своих чатов.
- Быстрый способ привязки: зайти ботом (с правами админа) в нужный чат/канал и выполнить `/bind_department <Название отдела>`. Бот сохранит текущий `chat.id` в `department_channel`. Команда доступна только пользователям из `ADMINS`.
- Владельца задаёт `OWNER_ID`. Команда `/add_admin <id>` (или ответом на сообщение) доступна только владельцу и добавляет администратора в таблицу `Admin`. Админы получают доступ к `/bind_department`.
- Снять админку может только владелец: `/unadd_admin <id|@username>`.
- Выгрузка сотрудников: команда владельца `/list_employees` (выведет до 200 активных сотрудников из `employees_ref`).
- Привязка отдела к каналу можно изменить только владельцу. Админ может создать привязку, если её нет, но менять существующую связь — только владелец.
- Отдельная БД для каналов/админов: укажи `META_DB_URL`, прогоняй команды `npm run prisma:push:meta` и `npm run prisma:generate:meta` для этой схемы.
- Проверка/удаление пользователей (для админов/владельца):
  - `/user_status <telegram_id>` — показать статус пользователя в канале его отдела.
  - `/remove_user <telegram_id>` — удалить пользователя из канала его отдела, с логированием в `audit_logs`.

## Что поменять под прод
- Подставить Postgres `DB_URL` и выполнить `prisma migrate`.
- Ограничить доступ к боту по allowlist или командам админа.
- Добавить обработку вебхуком вместо long polling.
- Добавить ревокацию ссылок и проверки статуса использования, если потребуется.

